<?php
class Exploit extends Model {

	public $vuln;
	public $host;
	public $port;
	public $virtualhost;

	public $status;
	public $data;

	public function __construct($vuln, $host, $port, $virtualhost){
		$this->vuln = $vuln;
		$this->host = $host;
		$this->port = $port;
		$this->virtualhost = $virtualhost;
	}

	public function preRun(){
		//Check if the target is alive etc
		return true;
	}

	public function run($shellPath=null){}
	public function save(){
		//Save the data creating a new Vuln_host entry
		$vulnHost = VulnHost::getVulnHostByVulnIpPortHost(
			$this->vuln->id,
			$this->host->ip,
			$this->port,
			$this->virtualHost->host
		);
		if(!$vulnHost->id){
			$vulnHost = new VulnHost();
		}
		$vulnHost->vuln = $this->vuln->module;
		$vulnHost->ip = $this->host->ip;
		$vulnHost->port = $this->port;
		$vulnHost->host = $this->virtualHost->host;
		$vulnHost->status = $this->status;
		$vulnHost->data = $this->data;
		if($vulnHost->id){
			return $vulnHost->update();
		}else{
			return $vulnHost->insert();
		}
	}

	public static function curl($url, $post=null, &$code=null){
		$ch = curl_init($url);
		curl_setopt($ch, CURLOPT_USERAGENT, "Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; Trident/4.0; .NET CLR 2.0.50727; .NET CLR 3.0.4506.2152; .NET CLR 3.5.30729)");
		curl_setopt($ch, CURLOPT_AUTOREFERER, true);
		curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
		curl_setopt($ch, CURLOPT_URL, $url);
		curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 10);
			curl_setopt($ch, CURLOPT_TIMEOUT, 10);
		if($post){
			curl_setopt($ch, CURLOPT_POST , true);
			curl_setopt($ch, CURLOPT_POSTFIELDS , $post);
		}
		$exec = curl_exec($ch);
		$code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
		curl_close($ch);
		return $exec;
	}
}
